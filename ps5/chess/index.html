<!DOCTYPE html>
<html lang="en">

<body />

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/favicon.png" type="image/x-icon">
    <link rel="stylesheet" href="style.css">
    <title>Chess - FrontendTitan</title>
</head>

<script>
    // Generate the chess board,
    // IIFE to avoid polluting the global scope and it's used once
    (() => {
        const table = document.createElement('table')
        table.className = 'chess-board'
        document.body.appendChild(table)

        // Create the chessboard rows and columns
        for (let i = 8; i >= 1; i--) {
            const row = document.createElement('tr')

            for (let j = 1; j <= 8; j++) {
                const cell = document.createElement('td')

                if (i === 1) {
                    const p = document.createElement('p')
                    p.textContent = String.fromCharCode(64 + j)
                    p.classList = 'coordinate-letter'
                    cell.appendChild(p)
                }

                if (j === 1) {
                    const p = document.createElement('p')
                    p.textContent = i
                    p.classList = 'coordinate-number'
                    cell.appendChild(p)
                }

                // 'light' or 'dark' based on row and column indices
                if ((i + j) % 2 === 0) {
                    cell.className = 'light'
                } else {
                    cell.className = 'dark'
                }

                // Piece Insertion
                if (i === 2 || i === 7) {
                    const piece = document.createElement('img')
                    piece.className = 'piece'
                    piece.src = `pieces/${i === 2 ? 'w' : 'b'}_pawn_png_shadow_1024px.png`
                    cell.appendChild(piece)
                } else if (i === 1 || i === 8) {
                    const piece = document.createElement('img')
                    piece.className = 'piece'
                    const pieces = ['rook', 'knight', 'bishop', 'queen', 'king', 'bishop', 'knight', 'rook']
                    piece.src = `pieces/${i === 1 ? 'w' : 'b'}_${pieces[j - 1]}_png_shadow_1024px.png`
                    cell.appendChild(piece)
                }

                row.appendChild(cell)
            }

            table.appendChild(row)
        }
    })()

    /**
     * Layout for the pieces object inside the array
     * {
     *  piece: 'pawn',
     *  color: 'white',
     *  position: 'A2'
     *  piece: <img class="piece" src="pieces/w_pawn_png_shadow_1024px.png">
     * }
     */
    const pieces = []

    // Grab all pieces and add them to the pieces array
    const pieceElements = document.querySelectorAll('.piece')
    pieceElements.forEach(piece => {
        const color = piece.src.includes('w') ? 'white' : 'black'
        const pieceName = piece.src.split('_')[1]
        const position = piece.parentElement.cellIndex + 1 + (8 - piece.parentElement.parentElement.rowIndex)
        pieces.push({ piece: pieceName, color, position, piece })
    })

    console.log(`Pieces:`, pieces)


    function movePiece(piece, newPosition) {
        const cell = document.querySelector(`.chess-board tr:nth-child(${8 - Math.floor((newPosition - 1) / 8)}) td:nth-child(${(newPosition - 1) % 8 + 1})`)
        const pieceInCell = cell.querySelector('.piece')

        if (pieceInCell) {
            const pieceInCellIndex = pieces.findIndex(p => p.piece === pieceInCell)
            pieces.splice(pieceInCellIndex, 1)
        }

        cell.appendChild(piece.piece)
        piece.position = newPosition
    }

    // Attach event listeners to chessboard cells
    const cells = document.querySelectorAll('.chess-board td')
    cells.forEach(cell => {
        cell.addEventListener('click', () => {
            const selectedPiece = pieces.find(piece => piece.piece === cell.querySelector('.piece'))
            if (!selectedPiece) return

            console.log(`Selected Piece:`, selectedPiece)
            cells.forEach(cell => cell.classList.remove('selected'))

            const selectedCell = {
                dom: selectedPiece.piece.parentElement,
                pos: getPosition(selectedPiece.piece.parentElement)
            }

            const chessBoard = document.querySelector('.chess-board')
            selectedCell.dom.classList.add('selected')

            console.log(`Selected Cell:`, selectedCell)
        })
    })

    // Deselect piece when clicking outside the chessboard
    document.addEventListener('click', (event) => {
        const chessBoard = document.querySelector('.chess-board')
        if (!chessBoard.contains(event.target)) {
            cells.forEach(cell => cell.classList.remove('selected'))
        }
    })

    /**
     * Get the position of the cell
     * Constructs a chess position from the cell indices
     * @param {HTMLElement} cellElement
     */
    function getPosition(cellElement) {
        console.log(`Element:`, cellElement)
        const row = 8 - cellElement.parentElement.rowIndex
        const column = String.fromCharCode(65 + cellElement.cellIndex)

        const pieceElement = cellElement.querySelector('.piece')
        const pieceName = pieceElement.src.split('_')[1].charAt(0).toUpperCase()
        const piece = pieceName === 'K' ? 'N' : (pieceName === 'P' ? '' : pieceName)

        return {
            row,
            column,
            piece: piece || undefined,
            position: `${piece}${column}${row}`,
            isPeice: pieceElement ? true : false
        }
    }
</script>

</html>